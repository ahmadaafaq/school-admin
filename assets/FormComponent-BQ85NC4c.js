import{k as ie,H as C,l as G,P as g,m as I,o as K,b as ne,z as oe,R as ue,a as o,A as O,j as s,B as x,v as U,I as V,S as W,M as $,C as z,q as D,U as X,n as de,E as ce,u as me,t as he,d as pe,p as ke,s as _e,f as Y,T as ge,h as Q,x as ve,y as fe}from"./index-dsWAcX1f.js";import{c as J}from"./index-mbUFVO5S.js";import{s as be}from"./MarksheetAction-mDmtmycw.js";import{s as je}from"./SubjectAction-p-rplfCF.js";import{s as $e}from"./StudentAction-ladqeq7I.js";import{u as xe}from"./index-uKa1WJb8.js";const ye=ie().shape({class:C().required("This Field is Required"),section:C().required("This Field is Required"),student:C().required("This Field is Required"),term:G().required("This Field is Required"),subjects:C().required("This Field is Required"),marks_obtained:C().required("This Field is Required"),total_marks:C().required("This Field is Required"),grade:G(),status:G()}),Fe={dbId:"",session:"",student:"",class:"",section:"",term:"",result:"",subjects:[],marks_obtained:"",total_marks:"",grade:"",remark:""},Z=({onChange:y,refId:E,setDirty:L,reset:d,setReset:v,updatedValues:m=null})=>{var A,p;const h=I(t=>t.allSubjects),F=I(t=>t.allFormStudents),{marksheetClassData:n}=I(t=>t.allMarksheets),q=K(),T=ne("(min-width:600px)"),{getStudents:w}=xe(),{createSession:H,findMultipleById:P,fetchAndSetAll:S}=X(),e=oe({initialValues:Fe,validationSchema:ye,enableReinitialize:!0,onSubmit:()=>R()});ue.useImperativeHandle(E,()=>({Submit:async()=>{await e.submitForm()}}));const R=()=>{y&&y({values:e.values,validated:e.isSubmitting?Object.keys(e.errors).length===0:!1})};return o.useEffect(()=>{d&&(e.resetForm(),v(!1))},[d]),o.useEffect(()=>{e.dirty&&L(!0)},[e.dirty]),o.useEffect(()=>{var t;(t=h==null?void 0:h.listData)!=null&&t.length||S(q,je,O.SubjectAPI)},[]),o.useEffect(()=>{n!=null&&n.classDataObj&&(e.setFieldValue("class",n.classDataObj.class_name),e.setFieldValue("section",n.classDataObj.section_name),e.setFieldValue("subjects",n.classDataObj.subject_ids.split(",")),w(n.classDataObj.class_id,n.classDataObj.section_id,$e,O))},[n==null?void 0:n.classDataObj]),o.useEffect(()=>{var t,a,f;if(m){let b=[];m.map((u,c)=>{e.setFieldValue(`marks_obtained_${c}`,u.marks_obtained),e.setFieldValue(`total_marks_${c}`,u.total_marks),e.setFieldValue(`grade_${c}`,u.grade),e.setFieldValue(`remark_${c}`,u.remark),e.setFieldValue(`result_${c}`,u.result),e.setFieldValue(`dbId_${c}`,u.id),b.push(u.subject_id)});let M;b!=null&&b.length&&(M=P(b.join(","),h==null?void 0:h.listData),e.setFieldValue("subjects",b)),e.setFieldValue("session",(t=m[0])==null?void 0:t.session),e.setFieldValue("student",(a=m[0])==null?void 0:a.student_id),e.setFieldValue("term",(f=m[0])==null?void 0:f.term),q(be({...n,selectedSubjects:M}))}},[m]),s.jsx(x,{m:"20px",children:s.jsxs("form",{ref:E,children:[s.jsxs("div",{style:{border:"2px solid #BADFE7",padding:"25px 10px",marginBottom:"40px",borderRadius:"12px"},children:[s.jsxs(x,{display:"grid",gap:"15px",gridTemplateColumns:"repeat(3, minmax(0, 1fr))",marginBottom:"20px",sx:{"& > div":{gridColumn:T?void 0:"span 4"}},children:[s.jsxs(U,{variant:"filled",sx:{minWidth:120},error:!!e.touched.session&&!!e.errors.session,children:[s.jsx(V,{id:"sessionField",children:"Session"}),s.jsx(W,{variant:"filled",labelId:"sessionField",name:"session",value:e.values.session,onChange:t=>e.setFieldValue("session",t.target.value),children:H().map(t=>s.jsx($,{value:t,name:t,children:t},t))}),s.jsx(z,{children:e.touched.session&&e.errors.session})]}),s.jsx(D,{fullWidth:!0,variant:"filled",type:"text",label:"Class",value:e.values.class||""}),s.jsx(D,{fullWidth:!0,variant:"filled",type:"text",label:"Section",value:e.values.section||""})]}),s.jsxs(x,{display:"flex",justifyContent:"space-evenly",alignItems:"center",mb:4,children:[s.jsxs(U,{variant:"filled",sx:{minWidth:320},error:!!e.touched.term&&!!e.errors.term,children:[s.jsx(V,{id:"termField",children:"Term"}),s.jsx(W,{variant:"filled",labelId:"termField",name:"term",onChange:e.handleChange,value:e.values.term,children:Object.keys(J.term).map(t=>s.jsx($,{value:t,children:J.term[t]},t))}),s.jsx(z,{children:e.touched.term&&e.errors.term})]}),s.jsxs(U,{variant:"filled",sx:{minWidth:320},error:!!e.touched.student&&!!e.errors.student,children:[s.jsx(V,{id:"studentField",children:"Student"}),s.jsx(W,{labelId:"studentField",name:"student",value:e.values.student||"",onChange:t=>e.setFieldValue("student",t.target.value),children:(p=(A=F==null?void 0:F.listData)==null?void 0:A.rows)!=null&&p.length?F.listData.rows.map(t=>s.jsx($,{value:t.id,name:`${t.firstname} ${t.lastname}`,children:`${t.firstname.charAt(0).toUpperCase()+t.firstname.slice(1)} ${t.lastname.charAt(0).toUpperCase()+t.lastname.slice(1)}`},t.id)):null}),s.jsx(z,{children:e.touched.session&&e.errors.session})]})]})]}),s.jsx("div",{style:{border:"2px solid #BADFE7",padding:"25px 10px",marginBottom:"30px",borderRadius:"12px"},children:n!=null&&n.selectedSubjects?n.selectedSubjects.map((t,a)=>s.jsxs(x,{display:"grid",gap:"15px",gridTemplateColumns:"repeat(6, minmax(0, 1fr))",mb:2,children:[s.jsx(x,{display:"flex",alignItems:"center",children:t==null?void 0:t.name}),s.jsx(D,{fullWidth:!0,variant:"outlined",type:"text",name:`marks_obtained_${a}`,label:"Marks Obtained*",onBlur:e.handleBlur,onChange:e.handleChange,value:e.values[`marks_obtained_${a}`],error:!!e.touched[`marks_obtained_${a}`]&&!!e.errors[`marks_obtained_${a}`],helperText:e.touched[`marks_obtained_${a}`]&&e.errors[`marks_obtained_${a}`],sx:{width:"150px"}}),s.jsx(D,{fullWidth:!0,variant:"outlined",type:"text",name:`total_marks_${a}`,label:"Total Marks*",onBlur:e.handleBlur,onChange:e.handleChange,value:e.values[`total_marks_${a}`],error:!!e.touched[`total_marks_${a}`]&&!!e.errors[`total_marks_${a}`],helperText:e.touched[`total_marks_${a}`]&&e.errors[`total_marks_${a}`],sx:{width:"150px"}}),s.jsx(D,{variant:"outlined",type:"text",name:`grade_${a}`,label:"Grade*",onBlur:e.handleBlur,onChange:e.handleChange,value:e.values[`grade_${a}`],error:!!e.touched[`grade_${a}`]&&!!e.errors[`grade_${a}`],helperText:e.touched[`grade_${a}`]&&e.errors[`grade_${a}`],sx:{width:"120px"}}),s.jsx(D,{variant:"outlined",type:"text",name:`remark_${a}`,label:"Remark",onBlur:e.handleBlur,onChange:e.handleChange,value:e.values[`remark_${a}`],error:!!e.touched[`remark_${a}`]&&!!e.errors[`remark_${a}`],helperText:e.touched[`remark_${a}`]&&e.errors[`remark_${a}`]}),s.jsxs(U,{variant:"filled",error:!!e.touched[`result_${a}`]&&!!e.errors[`result_${a}`],children:[s.jsx(V,{id:"resultField",children:"Result"}),s.jsx(W,{variant:"filled",labelId:"resultField",name:`result_${a}`,value:e.values[`result_${a}`]||"",onChange:f=>e.setFieldValue(`result_${a}`,f.target.value),children:m!=null&&m.length?[s.jsxs($,{value:"pass",children:[e.values[`result_${a}`]||"Pass"," "]},"pass"),s.jsxs($,{value:"fail",children:[e.values[`result_${a}`]||"Fail"," "]},"fail")]:[s.jsx($,{value:"pass",children:"Pass"},"pass"),s.jsx($,{value:"fail",children:"Fail"},"fail")]}),s.jsx(z,{children:e.touched[`result_${a}`]&&e.errors[`result_${a}`]})]})]},a)):null})]})})};Z.propTypes={onChange:g.func,refId:g.shape({current:g.any}),setDirty:g.func,reset:g.bool,setReset:g.func,userId:g.number,studentId:g.number,updatedValues:g.array};const Ae=()=>{const[y,E]=o.useState("Create"),[L,d]=o.useState(!1),[v,m]=o.useState({marksheetData:{values:null,validated:!1}}),[h,F]=o.useState(null),[n,q]=o.useState(!1),[T,w]=o.useState(!1),[H,P]=o.useState(!1),{marksheetClassData:S}=I(r=>r.allMarksheets),e=I(r=>r.menuItems.selected),R=I(r=>r.toastInfo),A=o.useRef(),p=de(),t=K(),a=ce(),f=me(),b=he(f.palette.mode),{typography:M}=pe(f.palette.mode),{state:u}=ke(),{toastAndNavigate:c,getLocalStorage:ee}=X();let B=(u==null?void 0:u.student_id)||(a==null?void 0:a.student_id),N=u==null?void 0:u.term;o.useEffect(()=>{const r=ee("menu");t(_e(r.selected))},[]);const se=o.useCallback(r=>{let k=[];d(!0);let _={session:r.marksheetData.values.session,student_id:r.marksheetData.values.student,class_id:S.classDataObj.class_id,section_id:S.classDataObj.section_id,term:r.marksheetData.values.term};return k=r.marksheetData.values.subjects.map((l,i)=>{_={..._,subject_id:l,id:r.marksheetData.values[`dbId_${i}`],marks_obtained:r.marksheetData.values[`marks_obtained_${i}`],total_marks:r.marksheetData.values[`total_marks_${i}`],grade:r.marksheetData.values[`grade_${i}`],remark:r.marksheetData.values[`remark_${i}`],result:r.marksheetData.values[`result_${i}`]},O.MarksheetAPI.updateMarksheet(_)}),Promise.all(k).then(()=>{d(!1),c(t,!0,"info","Successfully Updated",p,"/marksheet/listing")}).catch(l=>{var i,j;d(!1),c(t,!0,"error",l?(j=(i=l==null?void 0:l.response)==null?void 0:i.data)==null?void 0:j.msg:"An Error Occurred",p,0),console.log("error updating marksheet",l)})},[v]),te=o.useCallback((r,k)=>{d(!0);const _=[`/get-marksheet/?page=0&size=10&student=${r}&term=${k}`];O.CommonAPI.multipleAPICall("GET",_).then(l=>{if(l[0].data.status==="Success"){const i={marksheetData:l[0].data.data.rows};F(i),d(!1)}}).catch(l=>{var i,j;throw d(!1),c(t,!0,"error",l?(j=(i=l==null?void 0:l.response)==null?void 0:i.data)==null?void 0:j.msg:"An Error Occurred",p,0),l})},[B,N]),ae=o.useCallback(r=>{let k=[];d(!0);let _={session:r.marksheetData.values.session,student_id:r.marksheetData.values.student,class_id:S.classDataObj.class_id,section_id:S.classDataObj.section_id,term:r.marksheetData.values.term};return k=r.marksheetData.values.subjects.map((l,i)=>{_={..._,subject_id:l,marks_obtained:r.marksheetData.values[`marks_obtained_${i}`],total_marks:r.marksheetData.values[`total_marks_${i}`],grade:r.marksheetData.values[`grade_${i}`],remark:r.marksheetData.values[`remark_${i}`],result:r.marksheetData.values[`result_${i}`]},O.MarksheetAPI.createMarksheet(_)}),Promise.all(k).then(()=>{d(!1),c(t,!0,"success","Successfully Created",p,"/marksheet/listing")}).catch(l=>{var i,j;d(!1),c(t,!0,"error",l?(j=(i=l==null?void 0:l.response)==null?void 0:i.data)==null?void 0:j.msg:"An Error Occurred",p,0),console.log("error creating marksheet",l)})},[v]);o.useEffect(()=>{B&&!T&&(E("Update"),te(B,N)),v.marksheetData.validated?B?se(v):ae(v):w(!1)},[T,B,N]);const re=async()=>{await A.current.Submit(),w(!0)},le=(r,k)=>{k==="marksheet"&&m({...v,marksheetData:r})};return s.jsxs(x,{m:"10px",sx:{backgroundImage:f.palette.mode=="light"?`linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url(${Y})`:`linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), url(${Y})`,backgroundRepeat:"no-repeat",backgroundPosition:"start",backgroundSize:"cover",backgroundAttachment:"fixed"},children:[s.jsx(ge,{fontFamily:M.fontFamily,fontSize:M.h2.fontSize,color:b.grey[100],fontWeight:"bold",display:"inline-block",marginLeft:"20px",children:`${y} ${e}`}),s.jsx(Z,{onChange:r=>{le(r,"marksheet")},refId:A,setDirty:q,reset:H,setReset:P,updatedValues:h==null?void 0:h.marksheetData}),s.jsxs(x,{display:"flex",justifyContent:"end",m:"20px 20px 70px 0",children:[y==="Update"?null:s.jsx(Q,{type:"reset",color:"warning",variant:"contained",sx:{mr:3},disabled:!n||T,onClick:()=>{window.confirm("Do You Really Want To Reset?")&&P(!0)},children:"Reset"}),s.jsx(Q,{color:"error",variant:"contained",sx:{mr:3},onClick:()=>p("/marksheet/listing"),children:"Cancel"}),s.jsx(Q,{variant:"contained",type:"submit",onClick:()=>re(),disabled:!n,color:y==="Update"?"info":"success",children:"Submit"}),s.jsx(ve,{alerting:R.toastAlert,severity:R.toastSeverity,message:R.toastMessage})]}),L===!0?s.jsx(fe,{}):null]})};export{Ae as default};
