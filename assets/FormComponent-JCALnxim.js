import{k as ye,l as Te,H as pe,P as S,a as o,m as P,o as be,b as Se,z as Fe,R as _e,K as $e,A as V,j as s,B as F,v as Q,I as Y,S as J,M as X,C as Z,w as Ce,aE as Ae,U as xe,n as Ee,E as De,u as Me,t as ke,d as we,p as Pe,s as Re,f as fe,T as We,h as de,x as Ie,y as ze}from"./index-dsWAcX1f.js";import{c as ge}from"./index-mbUFVO5S.js";import{a as he}from"./SectionAction-OMdiSl6G.js";import{a as He,s as Ve}from"./SubjectAction-p-rplfCF.js";import{s as Be}from"./SchoolDurationAction-3qyOhY_P.js";import{u as Oe}from"./index-uKa1WJb8.js";const Le=ye().shape({day:Te().required("This Field is Required"),class:pe().required("This Field is Required"),section:pe().required("This Field is Required")}),Ue={dbId:"",period:[],day:"",class:"",section:"",subject:[],duration:[]},ve=({onChange:R,refId:ee,setDirty:oe,reset:b,setReset:$,classData:p,setClassData:B,allSubjects:te,updatedValues:v=null})=>{var E,D,M,z,ae,ie,ne,le,re,G,r,x,k,m,u,f,K,me;const[a,O]=o.useState([]),T=P(t=>t.schoolClasses),_=P(t=>t.schoolSections),h=P(t=>t.schoolSubjects),j=P(t=>t.allSchoolDurations),L=be(),y=Se("(min-width:600px)"),{getPaginatedData:ce}=Oe(),{fetchAndSetSchoolData:U,getLocalStorage:N,findMultipleById:w}=xe(),e=Fe({initialValues:Ue,validationSchema:Le,enableReinitialize:!0,onSubmit:()=>C()});_e.useImperativeHandle(ee,()=>({Submit:async()=>{await e.submitForm()}}));const C=()=>{R&&R({values:e.values,validated:e.isSubmitting?Object.keys(e.errors).length===0:!1})},W=new Date((E=a==null?void 0:a[0])==null?void 0:E.opening_time).toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0});function se(t){const[i,n]=t.split(":");if(isNaN(i)||isNaN(n))return"Invalid time format";const l=parseInt(i,10),c=parseInt(n,10);if(l<0||l>23||c<0||c>59)return"Invalid time value";const d=new Date;d.setHours(l),d.setMinutes(c);const H={hour:"numeric",minute:"numeric",hour12:!0};return new Intl.DateTimeFormat("en-US",H).format(d)}const q=(t=0,i=0,n,l)=>{const c=[],d=new Date;d.setHours(t,i,0);for(let H=0;H<n;H++){let ue=`${d.getHours()}:${d.getMinutes()==0?"00":d.getMinutes()}`;d.setMinutes(d.getMinutes()+l);let je=`${d.getHours()}:${d.getMinutes()==0?"00":d.getMinutes()}`;c.push(`${se(ue)}-${se(je)}`)}return c},g=q(W.slice(0,2).replace(":","").padStart(2,"0"),W.slice(2,5).replace(":",""),((D=a==null?void 0:a[0])==null?void 0:D.period)/((M=a==null?void 0:a[0])==null?void 0:M.halves),(z=a==null?void 0:a[0])==null?void 0:z.first_half_period_duration);let I=[],A=[];if(g.length){let t=g[g.length-1],i=t.split("-").splice(1).join("").slice(0,2).replace(":","").padStart(2,"0"),n=t.split("-").splice(1).join("").slice(2,5).replace(":",""),l=parseInt(n,10)+parseInt((ae=a==null?void 0:a[0])==null?void 0:ae.recess_time,10);I=q(i,l,((ie=a==null?void 0:a[0])==null?void 0:ie.period)/((ne=a==null?void 0:a[0])==null?void 0:ne.halves),(le=a==null?void 0:a[0])==null?void 0:le.second_half_period_duration),I.length&&(A=[...g,...I]),console.log("yuguy",i)}return o.useEffect(()=>{if(e.values.class&&(p!=null&&p.length)){const i=((p==null?void 0:p.filter(n=>n.class_id===e.values.class))||[]).map(({section_id:n,section_name:l})=>({section_id:n,section_name:l}));L(he(i))}},[(re=e.values)==null?void 0:re.class,p==null?void 0:p.length]),o.useEffect(()=>{var t;if(e.values.section&&(p!=null&&p.length)){const i=p==null?void 0:p.filter(l=>l.class_id===e.values.class&&l.section_id===e.values.section),n=i?w((t=i[0])==null?void 0:t.subject_ids,te):[];L(He(n))}},[(G=e.values)==null?void 0:G.class,(r=e.values)==null?void 0:r.section,p.length,te]),o.useEffect(()=>{b&&(e.resetForm(),$(!1))},[b]),o.useEffect(()=>{e.dirty&&oe(!0)},[e.dirty]),o.useEffect(()=>{var t,i,n;v&&(v==null||v.map((l,c)=>{e.setFieldValue(`period${c+1}`,l==null?void 0:l.period),e.setFieldValue(`duration${c+1}`,l==null?void 0:l.duration),e.setFieldValue(`subject${c+1}`,l==null?void 0:l.subject_id),e.setFieldValue(`dbId_${c}`,l==null?void 0:l.id)}),e.setFieldValue("class",(t=v[0])==null?void 0:t.class_id),e.setFieldValue("section",(i=v[0])==null?void 0:i.section_id),e.setFieldValue("day",(n=v[0])==null?void 0:n.day))},[v]),o.useEffect(()=>{var t,i,n;N("schoolInfo")&&(!((t=h==null?void 0:h.listData)!=null&&t.length)||!((i=T==null?void 0:T.listData)!=null&&i.length)||!((n=_==null?void 0:_.listData)!=null&&n.length))&&U(L,$e,he,B)},[]),o.useEffect(()=>{var i,n;let t=N("schoolInfo");(n=(i=j==null?void 0:j.listData)==null?void 0:i.rows)!=null&&n.length||ce(0,5,Be,V.SchoolDurationAPI),t!=null&&t.encrypted_id&&V.CommonAPI.decryptText(t).then(l=>{var c,d;if(l.status==="Success"){const H=(d=(c=j==null?void 0:j.listData)==null?void 0:c.rows)==null?void 0:d.filter(ue=>`${ue.school_id}`===l.data);O(H)}else l.status==="Error"&&console.log("Error Decrypting Data")})},[(k=(x=j==null?void 0:j.listData)==null?void 0:x.rows)==null?void 0:k.length]),o.useEffect(()=>{var t,i;A!=null&&A.length&&!((i=(t=e==null?void 0:e.values)==null?void 0:t.duration)!=null&&i.length)&&e.setFieldValue("duration",A)},[A]),o.useEffect(()=>{var t;if((t=a==null?void 0:a[0])!=null&&t.period){const i=Array.from({length:a[0].period},(n,l)=>l+1);e.setFieldValue("period",i)}},[a]),s.jsx(F,{m:"20px",children:s.jsxs("form",{ref:ee,children:[s.jsxs(F,{display:"grid",gap:"30px",gridTemplateColumns:"repeat(3, minmax(0, 1fr))",sx:{"& > div":{gridColumn:y?void 0:"span 4"},marginBottom:"50px"},children:[s.jsxs(Q,{variant:"filled",sx:{minWidth:120},error:!!e.touched.class&&!!e.errors.class,children:[s.jsx(Y,{id:"classField",children:"Class"}),s.jsx(J,{variant:"filled",labelId:"classField",name:"class",value:e.values.class,onChange:t=>{e.setFieldValue("class",t.target.value),e.values.section&&e.setFieldValue("section",""),e.values.subject&&e.setFieldValue("subject",[])},children:(m=T==null?void 0:T.listData)!=null&&m.length?T.listData.map(t=>s.jsx(X,{value:t.class_id,name:t.class_name,children:t.class_name},t.class_id)):null}),s.jsx(Z,{children:e.touched.class&&e.errors.class})]}),s.jsxs(Q,{variant:"filled",sx:{minWidth:120},error:!!e.touched.section&&!!e.errors.section,children:[s.jsx(Y,{id:"sectionField",children:"Section"}),s.jsx(J,{variant:"filled",labelId:"sectionField",name:"section",value:e.values.section,onChange:t=>{e.setFieldValue("section",t.target.value),e.values.subject&&e.setFieldValue("subject","")},children:(u=_==null?void 0:_.listData)!=null&&u.length?_.listData.map(t=>s.jsx(X,{value:t.section_id,name:t.section_name,children:t.section_name},t.section_id)):null}),s.jsx(Z,{children:e.touched.section&&e.errors.section})]}),s.jsxs(Q,{variant:"filled",sx:{minWidth:120},error:!!e.touched.day&&!!e.errors.day,children:[s.jsx(Y,{id:"dayField",children:"Day"}),s.jsx(J,{variant:"filled",name:"day",value:e.values.day,onChange:e.handleChange,children:Object.keys(ge.day).map(t=>s.jsx(X,{value:t,children:ge.day[t]},t))}),s.jsx(Z,{children:e.touched.day&&e.errors.day})]})]}),((f=a==null?void 0:a[0])==null?void 0:f.period)>0&&s.jsx(s.Fragment,{children:[...Array(a[0].period/2)].map((t,i)=>{var l;let n=i+1;return s.jsxs(F,{style:{display:"grid",gap:"10px",gridTemplateColumns:"repeat(3, minmax(0, 1fr))",margin:"0px 100px 20px 100px ",justifyItems:"center",alignItems:"center"},children:[s.jsxs(F,{sx:{fontWeight:"600",fontSize:"20px"},children:["Period ",n]}),s.jsx(F,{sx:{fontWeight:"500",fontSize:"15px"},children:g[i]}),s.jsxs(Q,{variant:"filled",sx:{minWidth:120},error:!!e.touched[`subject${n}`]&&!!e.errors[`subject${n}`],children:[s.jsx(Y,{id:"subjectField",children:"Subject"}),s.jsx(J,{sx:{minWidth:"280px"},variant:"filled",name:`subject${n}`,value:e.values[`subject${i+1}`]||null,onChange:c=>e.setFieldValue(`subject${i+1}`,c.target.value),children:(l=h==null?void 0:h.listData)!=null&&l.length?h.listData.map(c=>s.jsx(X,{value:c.id,name:c.name,children:c.name},c.id)):null}),s.jsxs(Z,{children:[e.touched[`subject${n}`]&&e.errors[`subject${n}`]," "]})]})]},i)})}),s.jsx(Ce,{sx:{width:"99%",marginBottom:"20px"},children:s.jsx(Ae,{color:"info",label:`Recess Time ${(K=a==null?void 0:a[0])==null?void 0:K.recess_time} min`,sx:{fontSize:"13px",fontWeight:"600",letterSpacing:"0.2em",padding:"12px"}})}),((me=a==null?void 0:a[0])==null?void 0:me.period)/2>0&&s.jsx(s.Fragment,{children:[...Array(a[0].period/2)].map((t,i)=>{var l,c;let n=((l=a==null?void 0:a[0])==null?void 0:l.period)/2+1;return s.jsxs(F,{sx:{display:"grid",gap:"10px",gridTemplateColumns:"repeat(3, minmax(0, 1fr))",margin:"0px 100px 20px 100px ",justifyItems:"center",alignItems:"center"},children:[s.jsxs(F,{sx:{fontWeight:"600",fontSize:"20px"},children:["Period ",i+n]}),s.jsx(F,{sx:{fontWeight:"500",fontSize:"15px"},children:I[i]}),s.jsxs(Q,{variant:"filled",sx:{minWidth:120},error:!!e.touched[`subject${i+n}`]&&!!e.errors[`subject${i+n}`],children:[s.jsx(Y,{id:"subjectField",children:"Subject"}),s.jsx(J,{sx:{minWidth:"280px"},variant:"filled",name:`subject${i+n}`,value:e.values[`subject${i+n}`]||null,onChange:d=>e.setFieldValue(`subject${i+n}`,d.target.value),children:(c=h==null?void 0:h.listData)!=null&&c.length?h.listData.map(d=>s.jsx(X,{value:d.id,name:d.name,children:d.name},d.id)):null}),s.jsxs(Z,{children:[e.touched[`subject${i+n}`]&&e.errors[`subject${i+n}`]," "]})]})]},i)})})]})})};ve.propTypes={onChange:S.func,refId:S.shape({current:S.any}),setDirty:S.func,reset:S.bool,setReset:S.func,classData:S.array,setClassData:S.func,allSubjects:S.array,updatedValues:S.object};const Je=()=>{var G;const[R,ee]=o.useState("Create"),[oe,b]=o.useState(!1),[$,p]=o.useState({timeTableData:{values:null,validated:!1}}),[B,te]=o.useState(null),[v,a]=o.useState(!1),[O,T]=o.useState(!1),[_,h]=o.useState(!1),[j,L]=o.useState([]),y=P(r=>r.allSubjects),ce=P(r=>r.menuItems.selected),U=P(r=>r.toastInfo),N=o.useRef(),w=Ee(),e=be(),C=De(),W=Me(),se=ke(W.palette.mode),{typography:q}=we(W.palette.mode),{state:g}=Pe(),{getLocalStorage:I,fetchAndSetAll:A,toastAndNavigate:E}=xe();let D=(g==null?void 0:g.class_id)||(C==null?void 0:C.class_id),M=(g==null?void 0:g.section_id)||(C==null?void 0:C.section_id),z=g==null?void 0:g.day;o.useEffect(()=>{const r=I("menu");e(Re(r.selected))},[]);const ae=o.useCallback(r=>{let x=[];b(!0);let k={day:r.timeTableData.values.day,class_id:r.timeTableData.values.class,section_id:r.timeTableData.values.section};return x=r.timeTableData.values.period.map((m,u)=>{const f={...k,period:m,id:r.timeTableData.values[`dbId_${u}`],duration:r.timeTableData.values.duration[u],subject_id:r.timeTableData.values[`subject${u+1}`]};V.TimeTableAPI.updateTimeTable(f)}),Promise.all(x).then(()=>{b(!1),E(e,!0,"info","Successfully updated")}).catch(m=>{var u,f;b(!1),E(e,!0,"error",m?(f=(u=m==null?void 0:m.response)==null?void 0:u.data)==null?void 0:f.msg:"An Error Occurred",w,0),console.log("error updating time table",m)})},[$]),ie=o.useCallback((r,x,k)=>{b(!0);const m=[`/get-time-tables/?page=0&size=12&classId=${r}&section=${x}&day=${k}`];V.CommonAPI.multipleAPICall("GET",m).then(u=>{if(u[0].data.status==="Success"){const f={timeTableData:u[0].data.data.rows};te(f),b(!1)}}).catch(u=>{var f,K;b(!1),E(e,!0,"error",u?(K=(f=u==null?void 0:u.response)==null?void 0:f.data)==null?void 0:K.msg:"An Error Occurred",w,0)})},[D,M,z]),ne=o.useCallback(r=>{let x=[];b(!0);let k={day:r.timeTableData.values.day,class_id:r.timeTableData.values.class,section_id:r.timeTableData.values.section};return x=r.timeTableData.values.period.map((m,u)=>{const f={...k,period:m,duration:r.timeTableData.values.duration[u],subject_id:r.timeTableData.values[`subject${u+1}`]};V.TimeTableAPI.createTimeTable(f)}),Promise.all(x).then(()=>{b(!1),E(e,!0,"success","Successfully Created",w,"/time-table/listing")}).catch(m=>{var u,f;b(!1),E(e,!0,"error",m?(f=(u=m==null?void 0:m.response)==null?void 0:u.data)==null?void 0:f.msg:"An Error Occurred",w,0),console.log("error creating time table",m)})},[$]);o.useEffect(()=>{var r;(r=y==null?void 0:y.listData)!=null&&r.length||A(e,Ve,V.SubjectAPI)},[(G=y==null?void 0:y.listData)==null?void 0:G.length]),o.useEffect(()=>{D&&M&&!O&&(ee("Update"),ie(D,M,z)),$.timeTableData.validated?D&&M?ae($):ne($):T(!1)},[O,D,M,z]);const le=async()=>{await N.current.Submit(),T(!0)},re=(r,x)=>{x=="timeTable"&&p({...$,timeTableData:r})};return s.jsxs(F,{m:"10px",sx:{backgroundImage:W.palette.mode=="light"?`linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url(${fe})`:`linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), url(${fe})`,backgroundRepeat:"no-repeat",backgroundPosition:"start",backgroundSize:"cover",backgroundAttachment:"fixed",height:"100%"},children:[s.jsx(We,{fontFamily:q.fontFamily,fontSize:q.h2.fontSize,color:se.grey[100],fontWeight:"bold",display:"inline-block",marginLeft:"20px",children:`${R} ${ce}`}),s.jsx(ve,{onChange:r=>{re(r,"timeTable")},refId:N,setDirty:a,reset:_,setReset:h,classData:j,setClassData:L,allSubjects:y==null?void 0:y.listData,updatedValues:B==null?void 0:B.timeTableData}),s.jsxs(F,{display:"flex",justifyContent:"end",m:"20px",children:[R==="Update"?null:s.jsx(de,{type:"reset",color:"warning",variant:"contained",sx:{mr:3},disabled:!v||O,onClick:()=>{window.confirm("Do You Really Want To Reset?")&&h(!0)},children:"Reset"}),s.jsx(de,{color:"error",variant:"contained",sx:{mr:3},onClick:()=>w("/time-table/listing"),children:"Cancel"}),s.jsx(de,{type:"submit",onClick:()=>le(),disabled:!v,color:R==="Update"?"info":"success",variant:"contained",children:"Submit"}),s.jsx(Ie,{alerting:U.toastAlert,severity:U.toastSeverity,message:U.toastMessage})]}),oe===!0?s.jsx(ze,{}):null]})};export{Je as default};
