import{q as de,P as g,l as M,w as te,h as ue,K as ce,R as me,a as n,A as x,j as t,B as $,C as w,I as E,S as P,M as f,N as W,z as D,E as Z,U as se,v as he,O as pe,u as ge,t as fe,k as ke,x as ve,y as _e,m as ee,T as be,p as Q,H as je,J as xe}from"./index-zLCHO5gj.js";import{s as $e}from"./MarksheetAction-1MvL35Bm.js";import{s as ye}from"./SubjectAction-cByBtOva.js";import{s as Fe}from"./StudentAction-ARQ8Q4-i.js";import{u as Se}from"./index-mkkoW40k.js";const Ce=de().shape({}),De={dbId:"",session:"",student:"",class:"",section:"",term:"",result:"",subjects:[],marks_obtained:"",total_marks:"",grade:"",remark:""},ae=({onChange:y,refId:U,setDirty:q,reset:m,setReset:F,updatedValues:o=null})=>{var T,v;const k=M(s=>s.allSubjects),S=M(s=>s.allFormStudents),{marksheetClassData:l}=M(s=>s.allMarksheets),V=te(),I=ue("(min-width:600px)"),{getStudents:z}=Se(),{createSession:J,findMultipleById:L,fetchAndSetAll:N}=se(),e=ce({initialValues:De,validationSchema:Ce,enableReinitialize:!0,onSubmit:()=>A()});me.useImperativeHandle(U,()=>({Submit:async()=>{await e.submitForm()}}));const A=()=>{y&&y({values:e.values,validated:e.isSubmitting?Object.keys(e.errors).length===0:!1})};return n.useEffect(()=>{m&&(e.resetForm(),F(!1))},[m]),n.useEffect(()=>{e.dirty&&q(!0)},[e.dirty]),n.useEffect(()=>{var s;(s=k==null?void 0:k.listData)!=null&&s.length||N(V,ye,x.SubjectAPI)},[]),n.useEffect(()=>{l!=null&&l.classDataObj&&(e.setFieldValue("class",l.classDataObj.class_name),e.setFieldValue("section",l.classDataObj.section_name),e.setFieldValue("subjects",l.classDataObj.subject_ids.split(",")),z(l.classDataObj.class_id,l.classDataObj.section_id,Fe,x))},[l==null?void 0:l.classDataObj]),n.useEffect(()=>{var s,a,_,H;if(o){let b=[];o.marksheetMappingData.map((u,j)=>{e.setFieldValue(`marks_obtained_${j}`,u.marks_obtained),e.setFieldValue(`total_marks_${j}`,u.total_marks),e.setFieldValue(`grade_${j}`,u.grade),e.setFieldValue(`remark_${j}`,u.remark),e.setFieldValue(`result_${j}`,u.result),e.setFieldValue(`dbId_${j}`,u.id),b.push(u.subject_id.toString())});let d;b!=null&&b.length&&(d=L(b.join(","),k==null?void 0:k.listData)),e.setFieldValue("session",(s=o.marksheetData[0])==null?void 0:s.session),e.setFieldValue("student",(a=o.marksheetData[0])==null?void 0:a.student_id),e.setFieldValue("term",(_=o.marksheetData[0])==null?void 0:_.term),e.setFieldValue("result",(H=o.marksheetData[0])==null?void 0:H.result),V($e({...l,selectedSubjects:d}))}},[o]),t.jsx($,{m:"20px",children:t.jsxs("form",{ref:U,children:[t.jsxs("div",{style:{border:"2px solid #BADFE7",padding:"25px 10px",marginBottom:"40px",borderRadius:"12px"},children:[t.jsxs($,{display:"grid",gap:"15px",gridTemplateColumns:"repeat(3, minmax(0, 1fr))",marginBottom:"20px",sx:{"& > div":{gridColumn:I?void 0:"span 4"}},children:[t.jsxs(w,{variant:"filled",sx:{minWidth:120},error:!!e.touched.session&&!!e.errors.session,children:[t.jsx(E,{id:"sessionField",children:"Session"}),t.jsx(P,{variant:"filled",labelId:"sessionField",name:"session",value:e.values.session,onChange:s=>e.setFieldValue("session",s.target.value),children:J().map(s=>t.jsx(f,{value:s,name:s,children:s},s))}),t.jsx(W,{children:e.touched.session&&e.errors.session})]}),t.jsx(D,{fullWidth:!0,variant:"filled",type:"text",label:"Class",value:e.values.class||""}),t.jsx(D,{fullWidth:!0,variant:"filled",type:"text",label:"Section",value:e.values.section||""})]}),t.jsxs($,{display:"flex",justifyContent:"space-evenly",alignItems:"center",mb:4,children:[t.jsxs(w,{variant:"filled",sx:{minWidth:320},error:!!e.touched.term&&!!e.errors.term,children:[t.jsx(E,{id:"termField",children:"Term"}),t.jsx(P,{variant:"filled",labelId:"termField",name:"term",onChange:e.handleChange,value:e.values.term,children:Object.keys(Z.term).map(s=>t.jsx(f,{value:s,children:Z.term[s]},s))}),t.jsx(W,{children:e.touched.term&&e.errors.term})]}),t.jsxs(w,{variant:"filled",sx:{minWidth:320},error:!!e.touched.student&&!!e.errors.student,children:[t.jsx(E,{id:"studentField",children:"Student"}),t.jsx(P,{labelId:"studentField",name:"student",value:e.values.student||"",onChange:s=>e.setFieldValue("student",s.target.value),children:(v=(T=S==null?void 0:S.listData)==null?void 0:T.rows)!=null&&v.length?S.listData.rows.map(s=>t.jsx(f,{value:s.id,name:`${s.firstname} ${s.lastname}`,children:`${s.firstname.charAt(0).toUpperCase()+s.firstname.slice(1)} ${s.lastname.charAt(0).toUpperCase()+s.lastname.slice(1)}`},s.id)):null}),t.jsx(W,{children:e.touched.session&&e.errors.session})]})]})]}),t.jsx("div",{style:{border:"2px solid #BADFE7",padding:"25px 10px",marginBottom:"30px",borderRadius:"12px"},children:l!=null&&l.selectedSubjects?l.selectedSubjects.map((s,a)=>t.jsxs($,{display:"grid",gap:"15px",gridTemplateColumns:"repeat(6, minmax(0, 1fr))",mb:2,children:[t.jsx($,{display:"flex",alignItems:"center",children:s==null?void 0:s.name}),t.jsx(D,{fullWidth:!0,variant:"outlined",type:"text",name:`marks_obtained_${a}`,label:"Marks Obtained*",onBlur:e.handleBlur,onChange:e.handleChange,value:e.values[`marks_obtained_${a}`],error:!!e.touched[`marks_obtained_${a}`]&&!!e.errors[`marks_obtained_${a}`],helperText:e.touched[`marks_obtained_${a}`]&&e.errors[`marks_obtained_${a}`],sx:{width:"150px"}}),t.jsx(D,{fullWidth:!0,variant:"outlined",type:"text",name:`total_marks_${a}`,label:"Total Marks*",onBlur:e.handleBlur,onChange:e.handleChange,value:e.values[`total_marks_${a}`],error:!!e.touched[`total_marks_${a}`]&&!!e.errors[`total_marks_${a}`],helperText:e.touched[`total_marks_${a}`]&&e.errors[`total_marks_${a}`],sx:{width:"150px"}}),t.jsx(D,{variant:"outlined",type:"text",name:`grade_${a}`,label:"Grade*",onBlur:e.handleBlur,onChange:e.handleChange,value:e.values[`grade_${a}`],error:!!e.touched[`grade_${a}`]&&!!e.errors[`grade_${a}`],helperText:e.touched[`grade_${a}`]&&e.errors[`grade_${a}`],sx:{width:"120px"}}),t.jsx(D,{variant:"outlined",type:"text",name:`remark_${a}`,label:"Remark",onBlur:e.handleBlur,onChange:e.handleChange,value:e.values[`remark_${a}`],error:!!e.touched[`remark_${a}`]&&!!e.errors[`remark_${a}`],helperText:e.touched[`remark_${a}`]&&e.errors[`remark_${a}`]}),t.jsxs(w,{variant:"filled",error:!!e.touched[`result_${a}`]&&!!e.errors[`result_${a}`],children:[t.jsx(E,{id:"resultField",children:"Result"}),t.jsx(P,{variant:"filled",labelId:"resultField",name:`result_${a}`,value:e.values[`result_${a}`]||"",onChange:_=>e.setFieldValue(`result_${a}`,_.target.value),children:o!=null&&o.length?[t.jsxs(f,{value:"pass",children:[e.values[`result_${a}`]||"Pass"," "]},"pass"),t.jsxs(f,{value:"fail",children:[e.values[`result_${a}`]||"Fail"," "]},"fail")]:[t.jsx(f,{value:"pass",children:"Pass"},"pass"),t.jsx(f,{value:"fail",children:"Fail"},"fail")]}),t.jsx(W,{children:e.touched[`result_${a}`]&&e.errors[`result_${a}`]})]})]},a)):null}),t.jsxs(w,{variant:"filled",sx:{minWidth:120},error:!!e.touched.result&&!!e.errors.result,children:[t.jsx(E,{children:"Result"}),t.jsxs(P,{variant:"filled",name:"result",value:e.values.result,onChange:e.handleChange,children:[t.jsx(f,{value:"pass",children:"Pass"},"pass"),",",t.jsx(f,{value:"fail",children:"Fail"},"fail")]}),t.jsx(W,{children:e.touched.result&&e.errors.result})]})]})})};ae.propTypes={onChange:g.func,refId:g.shape({current:g.any}),setDirty:g.func,reset:g.bool,setReset:g.func,userId:g.number,studentId:g.number,updatedValues:g.array};const Oe=()=>{const[y,U]=n.useState("Create"),[q,m]=n.useState(!1),[F,o]=n.useState({marksheetData:{values:null,validated:!1}}),[k,S]=n.useState(null),[l,V]=n.useState(!1),[I,z]=n.useState(!1),[J,L]=n.useState(!1),{marksheetClassData:N}=M(r=>r.allMarksheets),e=M(r=>r.menuItems.selected),A=M(r=>r.toastInfo),T=n.useRef(),v=he(),s=te(),a=pe(),_=ge(),H=fe(_.palette.mode),{typography:b}=ke(_.palette.mode),{state:d}=ve(),{toastAndNavigate:u,getLocalStorage:j}=se();let B=(d==null?void 0:d.student_id)||(a==null?void 0:a.student_id),K=d==null?void 0:d.term,O=d==null?void 0:d.id;n.useEffect(()=>{const r=j("menu");s(_e(r.selected))},[]);const re=n.useCallback((r,h,R)=>{m(!0);const C=[`/get-marksheet/?page=0&size=10&student=${r}&term=${h}`,`/get-marksheet-data/${R}`];x.CommonAPI.multipleAPICall("GET",C).then(i=>{if(i[0].data.status==="Success"){const p={marksheetData:i[0].data.data.rows,marksheetMappingData:i[1].data.data};S(p),m(!1)}}).catch(i=>{var p,c;throw m(!1),u(s,!0,"error",i?(c=(p=i==null?void 0:i.response)==null?void 0:p.data)==null?void 0:c.msg:"An Error Occurred",v,0),i})},[B,K,O]),le=n.useCallback((r,h)=>{let R;m(!0);let C={session:r.marksheetData.values.session,student_id:r.marksheetData.values.student,class_id:N.classDataObj.class_id,section_id:N.classDataObj.section_id,term:r.marksheetData.values.term,result:r.marksheetData.values.result};h?(C={...C,id:O},R=x.MarksheetAPI.updateMarksheet(C)):R=x.MarksheetAPI.createMarksheet(C),R.then(async i=>{h&&await x.MarksheetAPI.deleteFromMappingTable({marksheet_id:O}),r.marksheetData.values.subjects.map((p,c)=>{let oe={marksheet_id:h?O:i.data.data.id,subject_id:p,marks_obtained:r.marksheetData.values[`marks_obtained_${c}`],total_marks:r.marksheetData.values[`total_marks_${c}`],grade:r.marksheetData.values[`grade_${c}`],remark:r.marksheetData.values[`remark_${c}`],result:r.marksheetData.values[`result_${c}`]};x.MarksheetAPI.insertIntoMappingTable(oe).then(()=>{m(!1),u(s,!0,h?"info":"success",h?"Successfully Updated":"Successfully Created",v,"/marksheet/listing")}).catch(G=>{var Y,X;m(!1),u(s,!0,"error",G?(X=(Y=G==null?void 0:G.response)==null?void 0:Y.data)==null?void 0:X.msg:"An Error Occurred",v,0)})})}).catch(i=>{var p,c;m(!1),u(s,!0,"error",i?(c=(p=i==null?void 0:i.response)==null?void 0:p.data)==null?void 0:c.msg:"An Error Occurred",v,0)})},[F]);n.useEffect(()=>{B&&!I&&(U("Update"),re(B,K,O)),F.marksheetData.validated?le(F,B):z(!1)},[I,B,K]);const ne=async()=>{await T.current.Submit(),z(!0)},ie=(r,h)=>{h==="marksheet"&&o({...F,marksheetData:r})};return t.jsxs($,{m:"10px",sx:{backgroundImage:_.palette.mode=="light"?`linear-gradient(rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.85)), url(${ee})`:`linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), url(${ee})`,backgroundRepeat:"no-repeat",backgroundPosition:"start",backgroundSize:"cover",backgroundAttachment:"fixed"},children:[t.jsx(be,{fontFamily:b.fontFamily,fontSize:b.h2.fontSize,color:H.grey[100],fontWeight:"bold",display:"inline-block",marginLeft:"20px",children:`${y} ${e}`}),t.jsx(ae,{onChange:r=>{ie(r,"marksheet")},refId:T,setDirty:V,reset:J,setReset:L,updatedValues:k}),t.jsxs($,{display:"flex",justifyContent:"end",m:"20px 20px 70px 0",children:[y==="Update"?null:t.jsx(Q,{type:"reset",color:"warning",variant:"contained",sx:{mr:3},disabled:!l||I,onClick:()=>{window.confirm("Do You Really Want To Reset?")&&L(!0)},children:"Reset"}),t.jsx(Q,{color:"error",variant:"contained",sx:{mr:3},onClick:()=>v("/marksheet/listing"),children:"Cancel"}),t.jsx(Q,{variant:"contained",type:"submit",onClick:()=>ne(),disabled:!l,color:y==="Update"?"info":"success",children:"Submit"}),t.jsx(je,{alerting:A.toastAlert,severity:A.toastSeverity,message:A.toastMessage})]}),q===!0?t.jsx(xe,{}):null]})};export{Oe as default};
